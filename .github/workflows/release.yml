name: Release

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶ï¼šæŽ¨é€ä»¥ 'v' å¼€å¤´çš„æ ‡ç­¾

permissions:
  contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º release

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        run: go test -v ./...

      - name: Run go vet
        run: go vet ./...

      - name: Run go fmt check
        run: |
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "ä»¥ä¸‹æ–‡ä»¶éœ€è¦æ ¼å¼åŒ–ï¼š"
            gofmt -s -l .
            exit 1
          fi

  build:
    name: Build and Release
    runs-on: ubuntu-latest
    needs: test  # ä¾èµ–æµ‹è¯•ä»»åŠ¡æˆåŠŸå®Œæˆ
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ï¼Œç”¨äºŽç”Ÿæˆå˜æ›´æ—¥å¿—

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Build binaries
        run: |
          # åˆ›å»ºæž„å»ºç›®å½•
          mkdir -p dist
          
          # æž„å»ºä¸åŒå¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶
          # Windows amd64
          GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o dist/atc-windows-amd64.exe .
          
          # Windows arm64
          GOOS=windows GOARCH=arm64 go build -ldflags="-s -w" -o dist/atc-windows-arm64.exe .
          
          # Linux amd64
          GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o dist/atc-linux-amd64 .
          
          # Linux arm64
          GOOS=linux GOARCH=arm64 go build -ldflags="-s -w" -o dist/atc-linux-arm64 .
          
          # macOS amd64
          GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o dist/atc-darwin-amd64 .
          
          # macOS arm64 (Apple Silicon)
          GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o dist/atc-darwin-arm64 .

      - name: Create checksums
        run: |
          cd dist
          sha256sum * > checksums.txt

      - name: Generate release notes
        id: release_notes
        run: |
          # èŽ·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          # ç”Ÿæˆå˜æ›´æ—¥å¿—
          echo "## ðŸš€ æ–°åŠŸèƒ½ç‰¹æ€§" > release_notes.md
          echo "" >> release_notes.md
          
          if [ -n "$PREVIOUS_TAG" ]; then
            echo "### ðŸ“‹ å˜æ›´å†…å®¹ ($PREVIOUS_TAG...${{ steps.version.outputs.VERSION }})" >> release_notes.md
            echo "" >> release_notes.md
            
            # èŽ·å–æäº¤ä¿¡æ¯
            git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD >> release_notes.md
            echo "" >> release_notes.md
            echo "" >> release_notes.md
          fi
          
          echo "## ðŸ“¦ ä¸‹è½½è¯´æ˜Ž" >> release_notes.md
          echo "" >> release_notes.md
          echo "è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼š" >> release_notes.md
          echo "" >> release_notes.md
          echo "### Windows" >> release_notes.md
          echo "- **Intel/AMD 64ä½**: \`atc-windows-amd64.exe\`" >> release_notes.md
          echo "- **ARM 64ä½**: \`atc-windows-arm64.exe\`" >> release_notes.md
          echo "" >> release_notes.md
          echo "### Linux" >> release_notes.md
          echo "- **Intel/AMD 64ä½**: \`atc-linux-amd64\`" >> release_notes.md
          echo "- **ARM 64ä½**: \`atc-linux-arm64\`" >> release_notes.md
          echo "" >> release_notes.md
          echo "### macOS" >> release_notes.md
          echo "- **Intel èŠ¯ç‰‡**: \`atc-darwin-amd64\`" >> release_notes.md
          echo "- **Apple Silicon (M1/M2/M3)**: \`atc-darwin-arm64\`" >> release_notes.md
          echo "" >> release_notes.md
          echo "## ðŸ” å®‰å…¨éªŒè¯" >> release_notes.md
          echo "" >> release_notes.md
          echo "ä¸‹è½½åŽè¯·ä½¿ç”¨ \`checksums.txt\` æ–‡ä»¶éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶çš„å®Œæ•´æ€§ï¼š" >> release_notes.md
          echo "" >> release_notes.md
          echo "\`\`\`bash" >> release_notes.md
          echo "# Linux/macOS" >> release_notes.md
          echo "sha256sum -c checksums.txt" >> release_notes.md
          echo "" >> release_notes.md
          echo "# Windows (PowerShell)" >> release_notes.md
          echo "Get-FileHash atc-windows-amd64.exe -Algorithm SHA256" >> release_notes.md
          echo "\`\`\`" >> release_notes.md
          echo "" >> release_notes.md
          echo "## ðŸ“š ä½¿ç”¨è¯´æ˜Ž" >> release_notes.md
          echo "" >> release_notes.md
          echo "è¯¦ç»†ä½¿ç”¨è¯´æ˜Žè¯·å‚è€ƒé¡¹ç›®æ–‡æ¡£ï¼š" >> release_notes.md
          echo "- [ä¸­æ–‡æ–‡æ¡£](README_zh.md)" >> release_notes.md
          echo "- [English Documentation](README.md)" >> release_notes.md
          echo "- [é¡¹ç›®éœ€æ±‚æ–‡æ¡£](docs/é¡¹ç›®éœ€æ±‚æ–‡æ¡£.md)" >> release_notes.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: Release ${{ steps.version.outputs.VERSION }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ steps.version.outputs.VERSION }}
          path: dist/
          retention-days: 30