name: Release

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶ï¼šæŽ¨é€ä»¥ 'v' å¼€å¤´çš„æ ‡ç­¾

permissions:
  contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º release

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        run: go test -v ./...

      - name: Run go vet
        run: go vet ./...

      - name: Run go fmt check
        run: |
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "ä»¥ä¸‹æ–‡ä»¶éœ€è¦æ ¼å¼åŒ–ï¼š"
            gofmt -s -l .
            exit 1
          fi

  build:
    name: Build and Release
    runs-on: ubuntu-latest
    needs: test  # ä¾èµ–æµ‹è¯•ä»»åŠ¡æˆåŠŸå®Œæˆ
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ï¼Œç”¨äºŽç”Ÿæˆå˜æ›´æ—¥å¿—

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Set build variables
        id: build_vars
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          GIT_COMMIT=$(git rev-parse --short HEAD)
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "BUILD_TIME=${BUILD_TIME}" >> $GITHUB_OUTPUT
          echo "GIT_COMMIT=${GIT_COMMIT}" >> $GITHUB_OUTPUT

      - name: Create dist directory
        run: mkdir -p dist

      - name: Build for Windows
        run: |
          GOOS=windows GOARCH=amd64 go build -ldflags "-X main.version=${{ steps.build_vars.outputs.VERSION }} -X main.buildTime=${{ steps.build_vars.outputs.BUILD_TIME }} -X main.gitCommit=${{ steps.build_vars.outputs.GIT_COMMIT }}" -o dist/atc-windows-amd64.exe .
          GOOS=windows GOARCH=arm64 go build -ldflags "-X main.version=${{ steps.build_vars.outputs.VERSION }} -X main.buildTime=${{ steps.build_vars.outputs.BUILD_TIME }} -X main.gitCommit=${{ steps.build_vars.outputs.GIT_COMMIT }}" -o dist/atc-windows-arm64.exe .

      - name: Build for Linux
        run: |
          GOOS=linux GOARCH=amd64 go build -ldflags "-X main.version=${{ steps.build_vars.outputs.VERSION }} -X main.buildTime=${{ steps.build_vars.outputs.BUILD_TIME }} -X main.gitCommit=${{ steps.build_vars.outputs.GIT_COMMIT }}" -o dist/atc-linux-amd64 .
          GOOS=linux GOARCH=arm64 go build -ldflags "-X main.version=${{ steps.build_vars.outputs.VERSION }} -X main.buildTime=${{ steps.build_vars.outputs.BUILD_TIME }} -X main.gitCommit=${{ steps.build_vars.outputs.GIT_COMMIT }}" -o dist/atc-linux-arm64 .

      - name: Build for macOS
        run: |
          GOOS=darwin GOARCH=amd64 go build -ldflags "-X main.version=${{ steps.build_vars.outputs.VERSION }} -X main.buildTime=${{ steps.build_vars.outputs.BUILD_TIME }} -X main.gitCommit=${{ steps.build_vars.outputs.GIT_COMMIT }}" -o dist/atc-darwin-amd64 .
          GOOS=darwin GOARCH=arm64 go build -ldflags "-X main.version=${{ steps.build_vars.outputs.VERSION }} -X main.buildTime=${{ steps.build_vars.outputs.BUILD_TIME }} -X main.gitCommit=${{ steps.build_vars.outputs.GIT_COMMIT }}" -o dist/atc-darwin-arm64 .

      - name: Create checksums
        run: |
          cd dist
          sha256sum * > checksums.txt

      - name: Generate release notes
        id: release_notes
        run: |
          # èŽ·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          CURRENT_TAG="${{ steps.version.outputs.VERSION }}"
          
          # ç”Ÿæˆå˜æ›´æ—¥å¿—
          echo "## ðŸš€ ç‰ˆæœ¬ ${CURRENT_TAG}" > release_notes.md
          echo "" >> release_notes.md
          
          if [ -n "$PREVIOUS_TAG" ]; then
            echo "### ðŸ“‹ å˜æ›´å†…å®¹ (${PREVIOUS_TAG}...${CURRENT_TAG})" >> release_notes.md
            echo "" >> release_notes.md
            
            # èŽ·å–æäº¤èŒƒå›´
            COMMIT_RANGE="${PREVIOUS_TAG}..HEAD"
            
            # åˆ†ç±»æ”¶é›†æäº¤ä¿¡æ¯
            FEAT_COMMITS=$(git log --pretty=format:"%s" $COMMIT_RANGE | grep -E "^feat(\(.+\))?:" | sed 's/^feat[^:]*: /- /' || true)
            FIX_COMMITS=$(git log --pretty=format:"%s" $COMMIT_RANGE | grep -E "^fix(\(.+\))?:" | sed 's/^fix[^:]*: /- /' || true)
            DOCS_COMMITS=$(git log --pretty=format:"%s" $COMMIT_RANGE | grep -E "^docs(\(.+\))?:" | sed 's/^docs[^:]*: /- /' || true)
            REFACTOR_COMMITS=$(git log --pretty=format:"%s" $COMMIT_RANGE | grep -E "^(refactor|style|perf)(\(.+\))?:" | sed 's/^[^:]*: /- /' || true)
            TEST_COMMITS=$(git log --pretty=format:"%s" $COMMIT_RANGE | grep -E "^test(\(.+\))?:" | sed 's/^test[^:]*: /- /' || true)
            BUILD_COMMITS=$(git log --pretty=format:"%s" $COMMIT_RANGE | grep -E "^(build|ci|chore)(\(.+\))?:" | sed 's/^[^:]*: /- /' || true)
            
            # å…¶ä»–æäº¤ï¼ˆä¸ç¬¦åˆconventional commitsæ ¼å¼çš„ï¼‰
            OTHER_COMMITS=$(git log --pretty=format:"%s" $COMMIT_RANGE | grep -vE "^(feat|fix|docs|refactor|style|perf|test|build|ci|chore)(\(.+\))?:" | grep -v "^Merge " | sed 's/^/- /' || true)
            
            # è¾“å‡ºåˆ†ç±»çš„å˜æ›´å†…å®¹
            if [ -n "$FEAT_COMMITS" ]; then
              echo "#### ðŸš€ æ–°åŠŸèƒ½" >> release_notes.md
              echo "$FEAT_COMMITS" >> release_notes.md
              echo "" >> release_notes.md
            fi
            
            if [ -n "$FIX_COMMITS" ]; then
              echo "#### ðŸ› é—®é¢˜ä¿®å¤" >> release_notes.md
              echo "$FIX_COMMITS" >> release_notes.md
              echo "" >> release_notes.md
            fi
            
            if [ -n "$REFACTOR_COMMITS" ]; then
              echo "#### ðŸŽ¨ ä»£ç ä¼˜åŒ–" >> release_notes.md
              echo "$REFACTOR_COMMITS" >> release_notes.md
              echo "" >> release_notes.md
            fi
            
            if [ -n "$DOCS_COMMITS" ]; then
              echo "#### ðŸ“š æ–‡æ¡£æ›´æ–°" >> release_notes.md
              echo "$DOCS_COMMITS" >> release_notes.md
              echo "" >> release_notes.md
            fi
            
            if [ -n "$TEST_COMMITS" ]; then
              echo "#### ðŸ§ª æµ‹è¯•ç›¸å…³" >> release_notes.md
              echo "$TEST_COMMITS" >> release_notes.md
              echo "" >> release_notes.md
            fi
            
            if [ -n "$BUILD_COMMITS" ]; then
              echo "#### ðŸ”§ æž„å»º/å·¥å…·" >> release_notes.md
              echo "$BUILD_COMMITS" >> release_notes.md
              echo "" >> release_notes.md
            fi
            
            if [ -n "$OTHER_COMMITS" ]; then
              echo "#### ðŸ“ å…¶ä»–å˜æ›´" >> release_notes.md
              echo "$OTHER_COMMITS" >> release_notes.md
              echo "" >> release_notes.md
            fi
            
            # èŽ·å–æäº¤ç»Ÿè®¡ä¿¡æ¯
            COMMIT_COUNT=$(git rev-list --count $COMMIT_RANGE)
            AUTHOR_COUNT=$(git log --pretty=format:"%an" $COMMIT_RANGE | sort -u | wc -l)
            
            echo "#### ðŸ“Š ç»Ÿè®¡ä¿¡æ¯" >> release_notes.md
            echo "- **æäº¤æ•°é‡**: ${COMMIT_COUNT}" >> release_notes.md
            echo "- **è´¡çŒ®è€…**: ${AUTHOR_COUNT}" >> release_notes.md
            echo "- **å˜æ›´èŒƒå›´**: ${PREVIOUS_TAG}...${CURRENT_TAG}" >> release_notes.md
            echo "" >> release_notes.md
          else
            echo "è¿™æ˜¯é¡¹ç›®çš„é¦–ä¸ªæ­£å¼ç‰ˆæœ¬å‘å¸ƒï¼ðŸŽ‰" >> release_notes.md
            echo "" >> release_notes.md
            
            # èŽ·å–æ‰€æœ‰æäº¤çš„ç»Ÿè®¡
            TOTAL_COMMITS=$(git rev-list --count HEAD)
            echo "#### ðŸ“Š é¡¹ç›®ç»Ÿè®¡" >> release_notes.md
            echo "- **æ€»æäº¤æ•°**: ${TOTAL_COMMITS}" >> release_notes.md
            echo "- **é¦–æ¬¡å‘å¸ƒ**: ${CURRENT_TAG}" >> release_notes.md
            echo "" >> release_notes.md
          fi
          
          echo "## ðŸ“¦ ä¸‹è½½è¯´æ˜Ž" >> release_notes.md
          echo "" >> release_notes.md
          echo "è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼š" >> release_notes.md
          echo "" >> release_notes.md
          echo "### Windows" >> release_notes.md
          echo "- **Intel/AMD 64ä½**: \`atc-windows-amd64.exe\`" >> release_notes.md
          echo "- **ARM 64ä½**: \`atc-windows-arm64.exe\`" >> release_notes.md
          echo "" >> release_notes.md
          echo "### Linux" >> release_notes.md
          echo "- **Intel/AMD 64ä½**: \`atc-linux-amd64\`" >> release_notes.md
          echo "- **ARM 64ä½**: \`atc-linux-arm64\`" >> release_notes.md
          echo "" >> release_notes.md
          echo "### macOS" >> release_notes.md
          echo "- **Intel èŠ¯ç‰‡**: \`atc-darwin-amd64\`" >> release_notes.md
          echo "- **Apple Silicon (M1/M2/M3)**: \`atc-darwin-arm64\`" >> release_notes.md
          echo "" >> release_notes.md
          echo "## ðŸ” å®‰å…¨éªŒè¯" >> release_notes.md
          echo "" >> release_notes.md
          echo "ä¸‹è½½åŽè¯·ä½¿ç”¨ \`checksums.txt\` æ–‡ä»¶éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶çš„å®Œæ•´æ€§ï¼š" >> release_notes.md
          echo "" >> release_notes.md
          echo "\`\`\`bash" >> release_notes.md
          echo "# Linux/macOS" >> release_notes.md
          echo "sha256sum -c checksums.txt" >> release_notes.md
          echo "" >> release_notes.md
          echo "# Windows (PowerShell)" >> release_notes.md
          echo "Get-FileHash atc-windows-amd64.exe -Algorithm SHA256" >> release_notes.md
          echo "\`\`\`" >> release_notes.md
          echo "" >> release_notes.md
          echo "## ðŸ“š ä½¿ç”¨è¯´æ˜Ž" >> release_notes.md
          echo "" >> release_notes.md
          echo "è¯¦ç»†ä½¿ç”¨è¯´æ˜Žè¯·å‚è€ƒé¡¹ç›®æ–‡æ¡£ï¼š" >> release_notes.md
          echo "- [ä¸­æ–‡æ–‡æ¡£](README_zh.md)" >> release_notes.md
          echo "- [English Documentation](README.md)" >> release_notes.md
          echo "- [é¡¹ç›®éœ€æ±‚æ–‡æ¡£](docs/é¡¹ç›®éœ€æ±‚æ–‡æ¡£.md)" >> release_notes.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: Release ${{ steps.version.outputs.VERSION }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ steps.version.outputs.VERSION }}
          path: dist/
          retention-days: 30