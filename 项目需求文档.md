# API 自动化测试命令行工具需求规格说明书

## 1. 项目概述

本项目旨在实现一个API自动化测试命令行工具（ai-auto-test-cmd，简称atc），用于简化API测试流程，提高测试效率。该工具支持通过Dify Workflow API生成测试用例，也支持本地生成测试用例，并能批量执行测试请求。

## 2. 功能需求

### 2.1 测试用例生成功能

#### 2.1.1 通过Dify API生成测试用例【暂未实现】

可通过命令和参数访问Dify Workflow API，生成API测试用例并保存为本地CSV文件。

**可附加的参数包括：**
- 目标URL：指定Dify API的访问地址
- 请求参数格式：支持XML或JSON格式
- 请求参数：提供正例报文（支持命令行输入或文件输入）
- 生成用例数量：指定需要生成的测试用例数量
- 接口文档（可选）：提供接口文档以辅助生成更准确的测试用例
- **输入方式**：支持通过 `--raw` 参数直接输入或通过 `-f` 参数从文件读取正例

**交互要求：**
- 执行时间可能较长，需提供友好的进度提示
- 可能出现失败情况，需提供清晰的错误信息
- 支持直接返回或文档方式返回生成的测试用例

**使用示例：**

```shell
# 根据正例xml报文生成10条测试用例
atc gen -u https://xxx.dify.com/xxx/xxx --xml --raw "xxxx" -n 10

# 根据正例json报文生成20条测试用例
atc gen -u https://xxx.dify.com/xxx/xxx --json --raw "xxxx" -n 20

# 从文件读取正例xml报文生成测试用例
atc gen -u https://xxx.dify.com/xxx/xxx --xml -f input.xml -n 10

# 从文件读取正例json报文生成测试用例
atc gen -u https://xxx.dify.com/xxx/xxx --json -f input.json -n 15

# （可选）根据正例xml报文和接口文档生成5条正例报文
atc gen -u https://xxx.dify.com/xxx/xxx --xml --raw "xxxx" -n 5 -d xxx.xlsx -p
```

#### 2.1.2 本地生成测试用例

可以在不调用Dify API的情况下随机生成测试用例，用户只需提供正向用例XML或JSON报文。

**生成规则：**
- 根据正向用例值域上下浮动50%自动生成测试数据
  - 对于数字类型：值会在原始值的±50%范围内随机浮动
  - 对于字符串类型：长度可进行10%范围内的变化（90%-110%），内容中50%的字符变更为随机字符串（包含字母和数字）
  - 对于布尔类型：有50%的概率会翻转值
  - 对于数组类型：每个元素都会按照上述规则进行随机变化
  - 对于嵌套对象：递归应用上述规则到每个字段
- 用户可以指定生成用例的数量
- 支持将生成的测试用例保存为CSV文件，便于后续使用

**使用示例：**

```shell
# 本地根据正例xml报文生成10条测试用例（生成单列XML格式）
atc local-gen --xml --raw "<user><name>张三</name><age>25</age></user>" -n 10

# 本地根据正例json报文生成15条测试用例（生成单列JSON格式）
atc local-gen --json --raw '{"name":"张三","age":25}' -n 15

# 从文件读取正例xml报文生成测试用例
atc local-gen --xml -f input.xml -n 10

# 从文件读取正例json报文生成测试用例
atc local-gen --json -f input.json -n 15

# 本地根据正例json报文生成5条测试用例并保存到指定文件
atc local-gen --json -raw '{"name":"张三","age":25}' -n 5 -o test_data.csv
```

**数据处理能力：**
- 智能解析XML和JSON格式，支持复杂的嵌套结构
- 自动识别数据类型（数字、字符串、布尔值等）并应用相应的随机化规则
- 保留原始数据的结构和关系，只修改值
- **字段顺序一致性**：生成的测试用例字段顺序与正例输入保持完全一致
- **XML格式输出**：生成单列CSV文件，每行包含一个完整的XML文档，便于直接作为请求体使用
- **JSON格式输出**：生成单列CSV文件，每行包含一个完整的JSON字符串，便于直接作为请求体使用

**输入方式支持：**
- **命令行输入**：通过 `--raw` 参数直接在命令行中提供正例报文
- **文件输入**：通过 `-f` 或 `--file` 参数从文件中读取正例报文，支持XML和JSON文件格式

**输入文件格式要求：**
- **XML文件格式**：
  - 必须是标准完整的XML格式，符合XML语法规范
  - 文件内容不能为空或仅包含空白字符
  - 必须具有正确的XML结构（开始标签、结束标签匹配等）
  - 支持复杂的嵌套结构和属性
- **JSON文件格式**：
  - 必须是标准完整的JSON格式，符合JSON语法规范
  - 文件内容不能为空或仅包含空白字符
  - 必须具有正确的JSON结构（括号匹配、引号正确等）
  - 支持复杂的嵌套对象和数组结构
- **格式验证机制**：
  - 系统会在读取文件后立即进行格式验证
  - 如果文件格式不符合要求，会显示详细的错误信息并终止执行
  - 命令行输入的报文同样会进行格式验证
  - 验证失败时会提供具体的错误位置和原因，便于用户修正

#### 2.1.3 智能约束系统

本地生成测试用例功能支持智能约束系统，能够根据字段名自动应用相应的数据生成约束，生成更加真实、符合业务场景的测试数据。

**约束系统特性：**
- **智能字段识别**：根据字段名自动匹配相应的约束规则
- **多种数据类型支持**：日期、中文姓名、手机号、邮箱、地址、身份证号、数值等
- **灵活配置**：支持自定义约束配置文件
- **向后兼容**：不影响原有的随机变化生成模式

**使用示例：**

```shell
# 使用默认约束配置生成测试用例
atc local-gen --json -f test_example.json -n 5 --constraints -o output.csv

# 使用自定义约束配置文件
atc local-gen --json -f test_example.json -n 5 --constraints-file custom.toml -o output.csv

# 不使用约束，采用原有随机变化模式
atc local-gen --json -f test_example.json -n 5 -o output.csv

# 验证约束配置文件
atc validate

# 验证指定的约束配置文件
atc validate my-constraints.toml

# 验证配置文件并显示详细信息
atc validate --verbose constraints.toml
```

**约束配置文件（constraints.toml）：**

约束系统通过TOML配置文件定义字段约束规则，支持以下约束类型：

1. **日期字段约束**：
   - 支持字段：`date`、`create_date`、`update_date`等
   - 配置项：日期格式、最小日期、最大日期
   - 生成效果：20230101（YYYYMMDD格式）

2. **中文姓名约束**：
   - 支持字段：`name`、`user_name`、`username`、`real_name`等
   - 内置中文姓名数据集（姓氏+名字组合）
   - 生成效果：张伟、王芳、李明等真实中文姓名

3. **年龄约束**：
   - 支持字段：`age`
   - 配置项：最小值、最大值（1-120）
   - 生成效果：符合实际年龄范围的整数

4. **手机号约束**：
   - 支持字段：`phone`、`mobile`、`phone_number`等
   - 生成规则：中国大陆手机号格式（1[3-9]xxxxxxxxx）
   - 生成效果：13812345678、18987654321等

5. **邮箱约束**：
   - 支持字段：`email`、`email_address`等
   - 内置常见邮箱域名（qq.com、163.com、gmail.com等）
   - 生成效果：user123@qq.com、demo456@163.com等

6. **价格约束**：
   - 支持字段：`price`、`amount`、`money`等
   - 配置项：最小值、最大值、精度（小数位数）
   - 生成效果：123.45、9999.99等符合价格格式的浮点数

7. **中文地址约束**：
   - 支持字段：`address`、`addr`、`location`等
   - 内置中国主要城市地址数据集
   - 生成效果：北京市朝阳区建国门外大街1号等真实地址

8. **身份证号约束**：
   - 支持字段：`id_card`、`identity_card`、`card_no`等
   - 生成规则：符合中国身份证号格式（18位）
   - 生成效果：110101199001011234等

9. **数量约束**：
   - 支持字段：`quantity`、`qty`、`count`等
   - 配置项：最小值、最大值
   - 生成效果：符合业务逻辑的数量值

10. **状态码约束**：
    - 支持字段：`status`
    - 配置项：状态码范围（0-9）
    - 生成效果：符合系统状态定义的整数值

11. **ID编号约束**：
    - 支持字段：`id`、`user_id`、`order_id`等
    - 配置项：ID范围（1-999999）
    - 生成效果：符合系统ID规范的整数值

**内置数据集：**

约束系统包含丰富的内置中文数据集：
- **中文姓名数据集**：包含常见的中文姓氏和名字，支持真实姓名组合
- **中文地址数据集**：包含中国主要城市的真实地址信息
- **邮箱域名数据集**：包含常见的邮箱服务提供商域名

**约束匹配规则：**
- 优先进行精确字段名匹配
- 支持小写字段名匹配
- 未匹配到约束的字段将使用原有的随机变化逻辑
- 约束配置支持热更新，无需重新编译程序

**配置文件示例：**

```toml
# 日期字段约束
[date]
type = "date"
format = "20060102"  # Go时间格式
min_date = "20200101"
max_date = "20301231"
description = "日期字段，格式为YYYYMMDD"

# 姓名字段约束
[name]
type = "chinese_name"
description = "中文姓名"

# 年龄字段约束
[age]
type = "integer"
min = 1
max = 120
description = "年龄范围1-120"

# 内置数据集
[builtin_data]
first_names = ["张", "王", "李", "赵", "刘"]
last_names = ["伟", "芳", "娜", "敏", "静"]
addresses = ["北京市朝阳区建国门外大街1号", "上海市浦东新区陆家嘴环路1000号"]
email_domains = ["qq.com", "163.com", "126.com", "gmail.com"]
```

**生成效果对比：**

使用约束系统前（随机变化）：
```json
{"date":"27388202","name":"p","age":18,"phone":"11684695289","email":"1haDgsai8xOmpyU.C0m","price":122,"address":"K京w区","id_card":"71614056398366167"}
```

使用约束系统后（智能约束）：
```json
{"date":"20230101","name":"周桂兰","age":64,"phone":"17234495798","email":"test473@189.cn","price":161782.59,"address":"武汉市武昌区中南路99号","id_card":"500101198909148195"}
```

#### 2.1.4 约束配置验证

智能约束系统提供了配置文件验证功能，确保约束配置的正确性和完整性。

**验证功能特性：**

1. **格式验证**
   - 约束类型有效性检查
   - 必需字段完整性验证
   - 数据类型正确性验证

2. **内容验证**
   - 日期格式和范围验证
   - 数值范围合理性检查
   - 精度设置有效性验证
   - 内置数据完整性检查

3. **错误报告**
   - 详细的错误信息提示
   - 多错误批量报告
   - 错误位置精确定位

**验证命令：**

```shell
# 验证默认配置文件
atc validate

# 验证指定配置文件
atc validate my-constraints.toml

# 显示详细验证信息
atc validate --verbose
```

**验证规则：**

- **约束类型验证**：支持的类型包括 `date`、`chinese_name`、`phone`、`email`、`chinese_address`、`id_card`、`integer`、`float`
- **日期约束验证**：日期格式必须符合Go时间格式规范，最小日期不能晚于最大日期
- **数值约束验证**：最大值不能小于最小值，整数类型不应设置精度字段
- **内置数据验证**：姓氏、名字、地址列表不能为空，邮箱域名格式验证

**验证示例：**

正确配置验证：
```
🔍 正在验证约束配置文件: constraints.toml
✅ 配置文件验证通过！

📊 配置文件统计信息:
  • 约束字段总数: 29
  • 约束类型分布:
    - chinese_name: 4 个
    - date: 3 个
    - integer: 8 个
    - float: 3 个
    - phone: 3 个
    - email: 2 个
    - chinese_address: 3 个
    - id_card: 3 个
  • 内置数据集:
    - 姓氏: 20 个
    - 名字: 52 个
    - 地址: 15 个
    - 邮箱域名: 10 个
```

错误配置验证：
```
🔍 正在验证约束配置文件: invalid.toml
❌ 验证失败:
约束配置验证失败: 发现 3 个配置错误:
字段 'invalid_field': 无效的约束类型 'invalid_type'，支持的类型: date, chinese_name, phone, email, chinese_address, id_card, integer, float
字段 'missing_type': 约束类型 'type' 不能为空
字段 'bad_range': 最大值 50.00 不能小于最小值 100.00
```

### 2.2 测试执行功能

可通过命令及本地的CSV文件，批量请求目标系统接口，返回执行结果，并且可以保存。

**功能特点：**
- 支持POST和GET等HTTP方法
- 支持直接在命令行显示结果
- 支持将结果保存到指定文件
- **鉴权支持**：支持多种鉴权方式（Bearer Token、Basic Auth、API Key等）
- **自定义HTTP头**：支持添加自定义HTTP请求头，满足不同接口的要求

**使用示例：**

```shell
# 根据测试用例文件xxx.csv,批量使用POST方法请求目标系统http接口，发送JSON格式数据
atc request -u https://xxx.system.com/xxx/xxx -m post -f xxx.csv --json

# 根据测试用例文件xxx.csv,批量使用POST方法请求目标系统http接口，发送XML格式数据
atc request -u https://xxx.system.com/xxx/xxx -m post -f xxx.csv --xml

# 根据测试用例文件xxx.csv,批量使用GET方法请求目标系统http接口，结果默认保存至当前目录
atc request -u https://xxx.system.com/xxx/xxx -m get -f xxx.csv --json -s

# 根据测试用例文件xxx.csv,批量使用GET方法请求目标系统http接口，结果保存至指定目录及文件
atc request -u https://xxx.system.com/xxx/xxx -m get -f xxx.csv --json -s /xxx/tool/result.csv

# 启用调试模式，详细输出每个请求的URL、HTTP头和请求体信息，以及响应详情
atc request -u https://xxx.system.com/xxx/xxx -m post -f xxx.csv --json --debug

# 使用Bearer Token鉴权发送请求
atc request -u https://xxx.system.com/xxx/xxx -m post -f xxx.csv --json --auth-bearer "your_token_here"

# 使用Basic Auth鉴权发送请求
atc request -u https://xxx.system.com/xxx/xxx -m post -f xxx.csv --json --auth-basic "username:password"

# 添加自定义HTTP头发送请求
atc request -u https://xxx.system.com/xxx/xxx -m post -f xxx.csv --json --header "X-API-Key: your_api_key" --header "X-Client-Version: 1.0"

# 组合使用鉴权和自定义头
atc request -u https://xxx.system.com/xxx/xxx -m post -f xxx.csv --json --auth-bearer "token" --header "X-Request-ID: 12345"
```

**实现特性：**
- 支持从CSV文件读取测试数据，自动解析为测试用例
- 支持POST和GET请求方法
- 支持多种请求体格式：JSON和XML（必须明确指定格式）
- 强制要求用户选择请求体格式（--json 或 --xml），避免默认行为的歧义
- **智能CSV格式识别**：
  - XML格式：自动识别单列XML格式（列名为"XML"），直接使用每行的XML内容作为请求体
  - JSON格式：自动识别单列JSON格式（列名为"JSON"），直接使用每行的JSON内容作为请求体；对于多列格式，将各列数据组合为JSON请求体
- 支持并发请求以提高执行效率
- 支持自定义超时时间
- 智能数据类型解析（数字、布尔值、JSON等）
- **GET请求特殊处理**：当使用GET方法时，仅支持JSON格式的CSV文件，会将JSON数据的所有键值对转换为查询参数拼接到URL中
- **鉴权机制支持**：
  - **Bearer Token认证**：通过 `--auth-bearer` 参数提供Token
  - **Basic Auth认证**：通过 `--auth-basic` 参数提供用户名密码
  - **API Key认证**：通过自定义header方式添加API Key
- **自定义HTTP头支持**：
  - 通过 `--header` 参数添加自定义HTTP请求头
  - 支持添加多个header，每个header使用独立的 `--header` 参数
  - 格式：`--header "Key: Value"`
- 详细的执行结果显示，包括状态码、响应时间等
- 支持将测试结果保存为CSV文件
- 提供完整的统计信息（总数、成功数、失败数、成功率等）
- **调试模式支持**：
  - 使用 `--debug` 参数启用调试模式
  - **请求阶段**：格式化输出每个请求的URL、HTTP方法、超时时间、HTTP头和请求体内容
  - **响应阶段**：无论测试用例成功或失败，都会详细输出响应信息，包括：
    - 测试用例ID和基本信息（状态码、耗时、执行结果）
    - 错误信息（如果存在）
    - 完整的响应体内容（自动格式化JSON响应，便于阅读）
  - 便于问题排查、调试和结果分析

### 2.3 CSV文件格式约束

#### 2.3.1 生成阶段的格式约束

**XML格式生成：**
- `local-gen` 命令使用 `--xml` 参数时，生成单列CSV文件
- 列名固定为 "XML"
- 每行包含一个完整的XML字符串作为测试用例

**JSON格式生成：**
- `local-gen` 命令使用 `--json` 参数时，生成单列CSV文件
- 列名固定为 "JSON"
- 每行包含一个完整的JSON字符串作为测试用例

#### 2.3.2 使用阶段的格式识别

**智能格式识别：**
- `request` 命令能够自动识别CSV文件的格式类型
- **单列XML格式**：当CSV文件只有一列且列名为 "XML" 时，直接使用每行的XML内容作为请求体
- **单列JSON格式**：当CSV文件只有一列且列名为 "JSON" 时，直接使用每行的JSON内容作为请求体
- **多列格式**：当CSV文件有多列时，将各列数据组合为JSON对象作为请求体

**请求方法约束：**
- **POST请求**：支持XML和JSON两种格式的CSV文件
- **GET请求**：仅支持JSON格式的CSV文件，会将JSON数据的键值对转换为查询参数
- **参数验证**：当使用GET方法时，系统会自动检查并禁止使用`--xml`参数，强制要求使用`--json`参数

## 3. 技术要求

### 3.1 开发环境

- 编程语言：Go 1.24
- 命令行框架：Cobra 1.9.1
- 配置文件解析：go-toml/v2（用于约束配置文件解析）

### 3.2 性能要求

- 支持并发请求以提高测试效率
- 内存占用合理，避免大量数据导致内存溢出

### 3.3 可用性要求

- 命令行参数设计符合直觉，易于记忆
- 提供详细的帮助信息
- 错误信息清晰明确

## 4. 交付物

- 源代码
- 使用说明文档
- 可执行文件（支持多平台）
  - Windows amd64
  - macOS ARM
  - Linux ARM
  - Linux amd64

## 5. 待办事项

- [ ] gen命令完整实现：通过Dify Workflow API生成测试用例功能尚未实现，目前只有命令框架
- [x] 正例输入文件支持：gen和local-gen命令已支持从文件读取正例输入（通过-f参数），同时保持命令行输入兼容性
- [x] 输入文件格式验证：已实现XML和JSON格式的严格验证，包括文件输入和命令行输入的格式检查，提供详细错误信息
- [x] 生成测试用例字段顺序一致性：确保生成的测试用例字段顺序与正例保持一致
- [x] 数值格式优化：避免大数值转换为科学计数法，保持原始数值格式
- [x] 智能约束系统实现：已完成基于字段名的智能约束系统，支持多种数据类型的约束生成
- [x] 约束配置文件设计：已实现TOML格式的约束配置文件，支持灵活的字段约束定义
- [x] 中文测试数据用例库：已建立中文姓名、地址、邮箱域名等数据集，支持真实中文测试数据生成
- [x] 约束系统命令行集成：已在local-gen命令中集成--constraints和--constraints-file参数
- [x] 约束配置验证：已实现约束配置文件的格式验证和错误提示功能
- [ ] 约束系统扩展：支持更多字段类型和自定义约束规则
- [ ] 约束系统文档：编写约束系统的详细使用文档和最佳实践
- [ ] 鉴权支持：request命令需要支持各种鉴权方式
- [ ] 自定义header支持：允许用户自定义HTTP请求头
- [ ] 鉴权和header输入形式确定：需要确定鉴权信息和自定义header的输入格式
- [ ] 错误处理改进：提供更详细和友好的错误信息
- [ ] 进度显示优化：为长时间运行的操作提供更好的进度提示
- [ ] 大文件处理优化：优化大型CSV文件的读取和处理性能
- [ ] 单元测试补充：为核心功能模块添加完整的单元测试
- [ ] 集成测试添加：添加端到端的集成测试用例，确保不同组件之间的交互正常
- [ ] 用户手册：编写详细的用户使用手册和最佳实践
