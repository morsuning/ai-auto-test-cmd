# API 自动化测试命令行工具需求规格说明书

## 1. 项目概述

本项目旨在实现一个API自动化测试命令行工具，用于简化API测试流程，提高测试效率。该工具支持通过Dify Workflow API生成测试用例，也支持本地生成测试用例，并能批量执行测试请求。

## 2. 功能需求

### 2.1 测试用例生成功能

#### 2.1.1 通过Dify API生成测试用例

可通过命令和参数访问Dify Workflow API，生成API测试用例并保存为本地CSV文件。

**可附加的参数包括：**
- 目标URL：指定Dify API的访问地址
- 请求参数格式：支持XML或JSON格式
- 请求参数：提供正例报文（支持命令行输入或文件输入）
- 生成用例数量：指定需要生成的测试用例数量
- 接口文档（可选）：提供接口文档以辅助生成更准确的测试用例
- **输入方式**：支持通过 `-raw` 参数直接输入或通过 `-f` 参数从文件读取正例

**交互要求：**
- 执行时间可能较长，需提供友好的进度提示
- 可能出现失败情况，需提供清晰的错误信息
- 支持直接返回或文档方式返回生成的测试用例

**使用示例：**

```shell
# 根据正例xml报文生成10条测试用例
atc gen -u https://xxx.dify.com/xxx/xxx -xml -raw "xxxx" -n 10

# 根据正例json报文生成20条测试用例
atc gen -u https://xxx.dify.com/xxx/xxx -json -raw "xxxx" -n 20

# 从文件读取正例xml报文生成测试用例
atc gen -u https://xxx.dify.com/xxx/xxx -xml -f input.xml -n 10

# 从文件读取正例json报文生成测试用例
atc gen -u https://xxx.dify.com/xxx/xxx -json -f input.json -n 15

# （可选）根据正例xml报文和接口文档生成5条正例报文
atc gen -u https://xxx.dify.com/xxx/xxx -xml -raw "xxxx" -n 5 -d xxx.xlsx -p
```

#### 2.1.2 本地生成测试用例

可以在不调用Dify API的情况下随机生成测试用例，用户只需提供正向用例XML或JSON报文。

**生成规则：**
- 根据正向用例值域上下浮动50%自动生成测试数据
  - 对于数字类型：值会在原始值的±50%范围内随机浮动
  - 对于字符串类型：长度可进行10%范围内的变化（90%-110%），内容中50%的字符变更为随机字符串（包含字母和数字）
  - 对于布尔类型：有50%的概率会翻转值
  - 对于数组类型：每个元素都会按照上述规则进行随机变化
  - 对于嵌套对象：递归应用上述规则到每个字段
- 用户可以指定生成用例的数量
- 支持将生成的测试用例保存为CSV文件，便于后续使用

**使用示例：**

```shell
# 本地根据正例xml报文生成10条测试用例（生成单列XML格式）
atc local-gen --xml -raw "<user><name>张三</name><age>25</age></user>" -n 10

# 本地根据正例json报文生成15条测试用例（生成单列JSON格式）
atc local-gen --json -raw '{"name":"张三","age":25}' -n 15

# 从文件读取正例xml报文生成测试用例
atc local-gen --xml -f input.xml -n 10

# 从文件读取正例json报文生成测试用例
atc local-gen --json -f input.json -n 15

# 本地根据正例json报文生成5条测试用例并保存到指定文件
atc local-gen --json -raw '{"name":"张三","age":25}' -n 5 -o test_data.csv
```

**数据处理能力：**
- 智能解析XML和JSON格式，支持复杂的嵌套结构
- 自动识别数据类型（数字、字符串、布尔值等）并应用相应的随机化规则
- 保留原始数据的结构和关系，只修改值
- **字段顺序一致性**：生成的测试用例字段顺序与正例输入保持完全一致
- **XML格式输出**：生成单列CSV文件，每行包含一个完整的XML文档，便于直接作为请求体使用
- **JSON格式输出**：生成单列CSV文件，每行包含一个完整的JSON字符串，便于直接作为请求体使用

**输入方式支持：**
- **命令行输入**：通过 `--raw` 参数直接在命令行中提供正例报文
- **文件输入**：通过 `-f` 或 `--file` 参数从文件中读取正例报文，支持XML和JSON文件格式

**输入文件格式要求：**
- **XML文件格式**：
  - 必须是标准完整的XML格式，符合XML语法规范
  - 文件内容不能为空或仅包含空白字符
  - 必须具有正确的XML结构（开始标签、结束标签匹配等）
  - 支持复杂的嵌套结构和属性
- **JSON文件格式**：
  - 必须是标准完整的JSON格式，符合JSON语法规范
  - 文件内容不能为空或仅包含空白字符
  - 必须具有正确的JSON结构（括号匹配、引号正确等）
  - 支持复杂的嵌套对象和数组结构
- **格式验证机制**：
  - 系统会在读取文件后立即进行格式验证
  - 如果文件格式不符合要求，会显示详细的错误信息并终止执行
  - 命令行输入的报文同样会进行格式验证
  - 验证失败时会提供具体的错误位置和原因，便于用户修正

**参数约束定制化（规划中）：**
- **约束规则配置**：支持通过配置文件或命令行参数定义字段约束规则
- **数据长度范围**：可设定字符串、数组等数据类型的长度约束范围
- **中文测试数据**：内置中文文本用例库，支持按需生成固定长度的中文测试数据
- **数据类型约束**：支持对不同数据类型设置特定的生成规则和约束条件

### 2.2 测试执行功能

可通过命令及本地的CSV文件，批量请求目标系统接口，返回执行结果，并且可以保存。

**功能特点：**
- 支持POST和GET等HTTP方法
- 支持直接在命令行显示结果
- 支持将结果保存到指定文件
- **鉴权支持**：支持多种鉴权方式（Bearer Token、Basic Auth、API Key等）
- **自定义HTTP头**：支持添加自定义HTTP请求头，满足不同接口的要求

**使用示例：**

```shell
# 根据测试用例文件xxx.csv,批量使用POST方法请求目标系统http接口，发送JSON格式数据
atc request -u https://xxx.system.com/xxx/xxx -m post -f xxx.csv --json

# 根据测试用例文件xxx.csv,批量使用POST方法请求目标系统http接口，发送XML格式数据
atc request -u https://xxx.system.com/xxx/xxx -m post -f xxx.csv --xml

# 根据测试用例文件xxx.csv,批量使用GET方法请求目标系统http接口，结果默认保存至当前目录
atc request -u https://xxx.system.com/xxx/xxx -m get -f xxx.csv --json -s

# 根据测试用例文件xxx.csv,批量使用GET方法请求目标系统http接口，结果保存至指定目录及文件
atc request -u https://xxx.system.com/xxx/xxx -m get -f xxx.csv --json -s /xxx/tool/result.csv

# 启用调试模式，详细输出每个请求的URL、HTTP头和请求体信息，以及响应详情
atc request -u https://xxx.system.com/xxx/xxx -m post -f xxx.csv --json --debug

# 使用Bearer Token鉴权发送请求
atc request -u https://xxx.system.com/xxx/xxx -m post -f xxx.csv --json --auth-bearer "your_token_here"

# 使用Basic Auth鉴权发送请求
atc request -u https://xxx.system.com/xxx/xxx -m post -f xxx.csv --json --auth-basic "username:password"

# 添加自定义HTTP头发送请求
atc request -u https://xxx.system.com/xxx/xxx -m post -f xxx.csv --json --header "X-API-Key: your_api_key" --header "X-Client-Version: 1.0"

# 组合使用鉴权和自定义头
atc request -u https://xxx.system.com/xxx/xxx -m post -f xxx.csv --json --auth-bearer "token" --header "X-Request-ID: 12345"
```

**实现特性：**
- 支持从CSV文件读取测试数据，自动解析为测试用例
- 支持POST和GET请求方法
- 支持多种请求体格式：JSON和XML（必须明确指定格式）
- 强制要求用户选择请求体格式（--json 或 --xml），避免默认行为的歧义
- **智能CSV格式识别**：
  - XML格式：自动识别单列XML格式（列名为"XML"），直接使用每行的XML内容作为请求体
  - JSON格式：自动识别单列JSON格式（列名为"JSON"），直接使用每行的JSON内容作为请求体；对于多列格式，将各列数据组合为JSON请求体
- 支持并发请求以提高执行效率
- 支持自定义超时时间
- 智能数据类型解析（数字、布尔值、JSON等）
- **GET请求特殊处理**：当使用GET方法时，仅支持JSON格式的CSV文件，会将JSON数据的所有键值对转换为查询参数拼接到URL中
- **鉴权机制支持**：
  - **Bearer Token认证**：通过 `--auth-bearer` 参数提供Token
  - **Basic Auth认证**：通过 `--auth-basic` 参数提供用户名密码
  - **API Key认证**：通过自定义header方式添加API Key
- **自定义HTTP头支持**：
  - 通过 `--header` 参数添加自定义HTTP请求头
  - 支持添加多个header，每个header使用独立的 `--header` 参数
  - 格式：`--header "Key: Value"`
- 详细的执行结果显示，包括状态码、响应时间等
- 支持将测试结果保存为CSV文件
- 提供完整的统计信息（总数、成功数、失败数、成功率等）
- **调试模式支持**：
  - 使用 `--debug` 参数启用调试模式
  - **请求阶段**：格式化输出每个请求的URL、HTTP方法、超时时间、HTTP头和请求体内容
  - **响应阶段**：无论测试用例成功或失败，都会详细输出响应信息，包括：
    - 测试用例ID和基本信息（状态码、耗时、执行结果）
    - 错误信息（如果存在）
    - 完整的响应体内容（自动格式化JSON响应，便于阅读）
  - 便于问题排查、调试和结果分析

### 2.3 CSV文件格式约束

#### 2.3.1 生成阶段的格式约束

**XML格式生成：**
- `local-gen` 命令使用 `--xml` 参数时，生成单列CSV文件
- 列名固定为 "XML"
- 每行包含一个完整的XML字符串作为测试用例

**JSON格式生成：**
- `local-gen` 命令使用 `--json` 参数时，生成单列CSV文件
- 列名固定为 "JSON"
- 每行包含一个完整的JSON字符串作为测试用例

#### 2.3.2 使用阶段的格式识别

**智能格式识别：**
- `request` 命令能够自动识别CSV文件的格式类型
- **单列XML格式**：当CSV文件只有一列且列名为 "XML" 时，直接使用每行的XML内容作为请求体
- **单列JSON格式**：当CSV文件只有一列且列名为 "JSON" 时，直接使用每行的JSON内容作为请求体
- **多列格式**：当CSV文件有多列时，将各列数据组合为JSON对象作为请求体

**请求方法约束：**
- **POST请求**：支持XML和JSON两种格式的CSV文件
- **GET请求**：仅支持JSON格式的CSV文件，会将JSON数据的键值对转换为查询参数
- **参数验证**：当使用GET方法时，系统会自动检查并禁止使用--xml参数，强制要求使用--json参数

## 3. 技术要求

### 3.1 开发环境

- 编程语言：Go
- 命令行框架：Cobra

### 3.2 性能要求

- 支持并发请求以提高测试效率
- 内存占用合理，避免大量数据导致内存溢出

### 3.3 可用性要求

- 命令行参数设计符合直觉，易于记忆
- 提供详细的帮助信息
- 错误信息清晰明确

## 4. 交付物

- 源代码
- 使用说明文档
- 可执行文件（支持多平台）
  - Windows amd64
  - macOS ARM
  - Linux ARM
  - Linux amd64

## 5. 待办事项

- [ ] gen命令完整实现：通过Dify Workflow API生成测试用例功能尚未实现，目前只有命令框架
- [x] 正例输入文件支持：gen和local-gen命令已支持从文件读取正例输入（通过-f参数），同时保持命令行输入兼容性
- [x] 输入文件格式验证：已实现XML和JSON格式的严格验证，包括文件输入和命令行输入的格式检查，提供详细错误信息
- [x] 生成测试用例字段顺序一致性：确保生成的测试用例字段顺序与正例保持一致
- [x] 数值格式优化：避免大数值转换为科学计数法，保持原始数值格式
- [ ] 请求参数约束格式确定：需要设计和实现参数约束的输入格式和规范
- [ ] 测试数据长度范围设定：支持用户自定义测试数据的长度范围约束
- [ ] 中文测试数据用例库：建立中文文本用例库，实现按需随机取固定长度文本作为测试数据的功能
- [ ] 鉴权支持：request命令需要支持各种鉴权方式
- [ ] 自定义header支持：允许用户自定义HTTP请求头
- [ ] 鉴权和header输入形式确定：需要确定鉴权信息和自定义header的输入格式
- [ ] 错误处理改进：提供更详细和友好的错误信息
- [ ] 进度显示优化：为长时间运行的操作提供更好的进度提示
- [ ] 帮助文档完善：补充详细的使用说明和示例
- [ ] 大文件处理优化：优化大型CSV文件的读取和处理性能
- [ ] 单元测试补充：为核心功能模块添加完整的单元测试
- [ ] 集成测试添加：添加端到端的集成测试用例，确保不同组件之间的交互正常
- [ ] 代码重构：优化代码结构，提高可维护性
- [ ] 用户手册：编写详细的用户使用手册和最佳实践
