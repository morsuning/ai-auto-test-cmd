# API 自动化测试命令行工具需求规格说明书

## 1. 项目概述

本项目旨在实现一个API自动化测试命令行工具，用于简化API测试流程，提高测试效率。该工具支持通过Dify Workflow API生成测试用例，也支持本地生成测试用例，并能批量执行测试请求。

## 2. 功能需求

### 2.1 测试用例生成功能

#### 2.1.1 通过Dify API生成测试用例

可通过命令和参数访问Dify Workflow API，生成API测试用例并保存为本地CSV文件。

**可附加的参数包括：**
- 目标URL：指定Dify API的访问地址
- 请求参数格式：支持XML或JSON格式
- 请求参数：提供正例报文
- 生成用例数量：指定需要生成的测试用例数量
- 接口文档（可选）：提供接口文档以辅助生成更准确的测试用例

**交互要求：**
- 执行时间可能较长，需提供友好的进度提示
- 可能出现失败情况，需提供清晰的错误信息
- 支持直接返回或文档方式返回生成的测试用例

**使用示例：**

```shell
# 根据正例xml报文生成10条测试用例
atc gen -u https://xxx.dify.com/xxx/xxx -xml -raw "xxxx" -n 10

# 根据正例json报文生成20条测试用例
atc gen -u https://xxx.dify.com/xxx/xxx -json -raw "xxxx" -n 20

# （可选）根据正例xml报文和接口文档生成5条正例报文
atc gen -u https://xxx.dify.com/xxx/xxx -xml -raw "xxxx" -n 5 -d xxx.xlsx -p
```

#### 2.1.2 本地生成测试用例

可以在不调用Dify API的情况下随机生成测试用例，用户只需提供正向用例XML或JSON报文。

**生成规则：**
- 根据正向用例值域上下浮动50%自动生成测试数据
  - 对于数字类型：值会在原始值的±50%范围内随机浮动
  - 对于字符串类型：长度可进行10%范围内的变化（90%-110%），内容中50%的字符变更为随机字符串（包含字母和数字）
  - 对于布尔类型：有50%的概率会翻转值
  - 对于数组类型：每个元素都会按照上述规则进行随机变化
  - 对于嵌套对象：递归应用上述规则到每个字段
- 用户可以指定生成用例的数量
- 支持将生成的测试用例保存为CSV文件，便于后续使用

**使用示例：**

```shell
# 本地根据正例xml报文生成10条测试用例（生成单列XML格式）
atc local-gen -xml -raw "<user><name>张三</name><age>25</age></user>" -n 10

# 本地根据正例json报文生成15条测试用例（生成单列JSON格式）
atc local-gen -json -raw '{"name":"张三","age":25}' -n 15

# 本地根据正例json报文生成5条测试用例并保存到指定文件
atc local-gen -json -raw '{"name":"张三","age":25}' -n 5 -o test_data.csv
```

**数据处理能力：**
- 智能解析XML和JSON格式，支持复杂的嵌套结构
- 自动识别数据类型（数字、字符串、布尔值等）并应用相应的随机化规则
- 保留原始数据的结构和关系，只修改值
- **XML格式输出**：生成单列CSV文件，每行包含一个完整的XML文档，便于直接作为请求体使用
- **JSON格式输出**：生成单列CSV文件，每行包含一个完整的JSON字符串，便于直接作为请求体使用

### 2.2 测试执行功能

可通过命令及本地的CSV文件，批量请求目标系统接口，返回执行结果，并且可以保存。

**功能特点：**
- 支持POST和GET等HTTP方法
- 支持直接在命令行显示结果
- 支持将结果保存到指定文件

**使用示例：**

```shell
# 根据测试用例文件xxx.csv,批量使用POST方法请求目标系统http接口，发送JSON格式数据
atc request -u https://xxx.system.com/xxx/xxx -m post -f xxx.csv --json

# 根据测试用例文件xxx.csv,批量使用POST方法请求目标系统http接口，发送XML格式数据
atc request -u https://xxx.system.com/xxx/xxx -m post -f xxx.csv --xml

# 根据测试用例文件xxx.csv,批量使用GET方法请求目标系统http接口，结果默认保存至当前目录
atc request -u https://xxx.system.com/xxx/xxx -m get -f xxx.csv --json -s

# 根据测试用例文件xxx.csv,批量使用GET方法请求目标系统http接口，结果保存至指定目录及文件
atc request -u https://xxx.system.com/xxx/xxx -m get -f xxx.csv --json -s /xxx/tool/result.csv

# 启用调试模式，详细输出每个请求的URL、HTTP头和请求体信息，以及响应详情
atc request -u https://xxx.system.com/xxx/xxx -m post -f xxx.csv --json --debug
```

**实现特性：**
- 支持从CSV文件读取测试数据，自动解析为测试用例
- 支持POST和GET请求方法
- 支持多种请求体格式：JSON和XML（必须明确指定格式）
- 强制要求用户选择请求体格式（--json 或 --xml），避免默认行为的歧义
- **智能CSV格式识别**：
  - XML格式：自动识别单列XML格式（列名为"XML"），直接使用每行的XML内容作为请求体
  - JSON格式：自动识别单列JSON格式（列名为"JSON"），直接使用每行的JSON内容作为请求体；对于多列格式，将各列数据组合为JSON请求体
- 支持并发请求以提高执行效率
- 支持自定义超时时间
- 智能数据类型解析（数字、布尔值、JSON等）
- **GET请求特殊处理**：当使用GET方法时，仅支持JSON格式的CSV文件，会将JSON数据的所有键值对转换为查询参数拼接到URL中
- 详细的执行结果显示，包括状态码、响应时间等
- 支持将测试结果保存为CSV文件
- 提供完整的统计信息（总数、成功数、失败数、成功率等）
- **调试模式支持**：
  - 使用 `--debug` 参数启用调试模式
  - **请求阶段**：格式化输出每个请求的URL、HTTP方法、超时时间、HTTP头和请求体内容
  - **响应阶段**：无论测试用例成功或失败，都会详细输出响应信息，包括：
    - 测试用例ID和基本信息（状态码、耗时、执行结果）
    - 错误信息（如果存在）
    - 完整的响应体内容（自动格式化JSON响应，便于阅读）
  - 便于问题排查、调试和结果分析

### 2.3 CSV文件格式约束

#### 2.3.1 生成阶段的格式约束

**XML格式生成：**
- `local-gen` 命令使用 `--xml` 参数时，生成单列CSV文件
- 列名固定为 "XML"
- 每行包含一个完整的XML字符串作为测试用例

**JSON格式生成：**
- `local-gen` 命令使用 `--json` 参数时，生成单列CSV文件
- 列名固定为 "JSON"
- 每行包含一个完整的JSON字符串作为测试用例

#### 2.3.2 使用阶段的格式识别

**智能格式识别：**
- `request` 命令能够自动识别CSV文件的格式类型
- **单列XML格式**：当CSV文件只有一列且列名为 "XML" 时，直接使用每行的XML内容作为请求体
- **单列JSON格式**：当CSV文件只有一列且列名为 "JSON" 时，直接使用每行的JSON内容作为请求体
- **多列格式**：当CSV文件有多列时，将各列数据组合为JSON对象作为请求体

**请求方法约束：**
- **POST请求**：支持XML和JSON两种格式的CSV文件
- **GET请求**：仅支持JSON格式的CSV文件，会将JSON数据的键值对转换为查询参数
- **参数验证**：当使用GET方法时，系统会自动检查并禁止使用--xml参数，强制要求使用--json参数

## 3. 技术要求

### 3.1 开发环境

- 编程语言：Go
- 命令行框架：Cobra

### 3.2 性能要求

- 支持并发请求以提高测试效率
- 内存占用合理，避免大量数据导致内存溢出

### 3.3 可用性要求

- 命令行参数设计符合直觉，易于记忆
- 提供详细的帮助信息
- 错误信息清晰明确

## 4. 交付物

- 源代码
- 使用说明文档
- 可执行文件（支持多平台）
  - Windows amd64
  - macOS ARM
  - Linux ARM
  - Linux amd64

## 5. 项目计划

- 需求分析与设计：[待定]
- 开发实现：[待定]
- 测试验证：[待定]
- 交付上线：[待定]